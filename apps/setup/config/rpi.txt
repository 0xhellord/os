/*++

Copyright (c) 2015 Minoca Corp. All Rights Reserved

Module Name:

    rpi.txt

Abstract:

    This module implements the setup recipe for Raspberry Pi.

Author:

    Evan Green 19-Oct-2015

Environment:

    Setup

--*/

DriverFiles += DriverFilesArm;
DriverFiles += [
    "dwhci.drv",
    "dmab2709.drv",
    "sdbm2709.drv",
];

BootDrivers += [
    "dmab2709.drv",
    "sdbm2709.drv",
];

RpiFirmwareBlobFiles = [
    "config.txt",
    "start.elf",
    "fixup.dat",
    "bootcode.bin"
];

//
// Copy the firmware to the system partition for recovery if needed.
//

RpiFirmwareBlobsSystemCopy = {
    "Destination": SystemDir + "rpi/",
    "Source": SourceDir + "rpi/",
    "SourceVolume": 0,
    "Files": RpiFirmwareBlobFiles
};

RpiFirmwareSystemCopy = {
    "Destination": SystemDir + "rpi/rpifw",
    "Source": SourceDir + "rpifw",
    "SourceVolume": 0
};

//
// Copy the firmware to the boot partition.
//

RpiFirmwareBlobsCopy = {
    "Destination": "/",
    "Source": SourceDir + "rpi/",
    "SourceVolume": 0,
    "Files": RpiFirmwareBlobFiles
};

RpiFirmwareCopy = {
    "Destination": "/rpifw",
    "Source": SourceDir + "rpifw",
    "SourceVolume": 0,
};

TotalCopy += [RpiFirmwareBlobsSystemCopy, RpiFirmwareSystemCopy];
TotalBootCopy += [RpiFirmwareBlobsCopy, RpiFirmwareCopy];
DiskData["Format"] = PARTITION_FORMAT_MBR;

//
// Set the EFI boot manager name.
//

BootmefiCopy["Destination"] += EFI_DEFAULT_APP_ARM;
BootPartition["Alignment"] = 1 * MEGABYTE;
BootPartition["Size"] = 20 * MEGABYTE;
